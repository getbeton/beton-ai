# Commit 3.2: Add Bulk Selection for Tables

## Goal
Enable multi-table operations using the existing bulk selection implementation from the code snippet

## Dependencies
- Commit 3.1: Improve table row design

## Files Modified
- `frontend/src/components/tables/BulkActionToolbar.tsx` (extract from snippet)
- `frontend/src/components/tables/TableDashboard.tsx` (enhance existing bulk selection)
- `frontend/src/hooks/useBulkSelection.ts` (extract selection logic)

## Implementation Steps

### Step 1: Extract BulkActionToolbar Component
```tsx
// Component already implemented in code snippet:
const BulkActionToolbar: React.FC<{
  selectedCount: number;
  onClearSelection: () => void;
  onBulkDelete: () => void;
  onBulkExport: () => void;
}> = ({ selectedCount, onClearSelection, onBulkDelete, onBulkExport }) => {
  // Features already implemented:
  // - AnimatePresence for smooth show/hide
  // - Blue background with selection count
  // - Clear selection button
  // - Export and Delete bulk actions
  // - Responsive design for mobile/desktop
};
```

### Step 2: Enhance Bulk Selection State Management
```tsx
// Current implementation uses useRef for performance:
const selectedTablesRef = useRef(new Set<string>());
const [selectedTables, setSelectedTables] = new Set<string>();

// Enhance with more robust state management:
const [bulkSelectionState, setBulkSelectionState] = useState({
  selectedIds: new Set<string>(),
  isSelecting: false,
  showBulkActions: false
});

// Optimized selection handlers:
const handleTableSelect = useCallback((id: string) => {
  setBulkSelectionState(prev => {
    const newSelected = new Set(prev.selectedIds);
    if (newSelected.has(id)) {
      newSelected.delete(id);
    } else {
      newSelected.add(id);
    }
    
    return {
      ...prev,
      selectedIds: newSelected,
      showBulkActions: newSelected.size > 0
    };
  });
}, []);
```

### Step 3: Implement Select All Functionality
```tsx
// Enhanced select all from code snippet:
const handleSelectAll = useCallback(() => {
  setBulkSelectionState(prev => {
    const allTableIds = sortedTables.map(table => table.id);
    const isAllSelected = prev.selectedIds.size === allTableIds.length && allTableIds.length > 0;
    
    return {
      ...prev,
      selectedIds: isAllSelected ? new Set() : new Set(allTableIds),
      showBulkActions: !isAllSelected && allTableIds.length > 0
    };
  });
}, [sortedTables]);

// Select all checkbox component:
<div className="flex items-center space-x-2 sm:space-x-4 mb-3 sm:mb-4 p-3 bg-muted rounded-lg">
  <Checkbox
    checked={bulkSelectionState.selectedIds.size === sortedTables.length && sortedTables.length > 0}
    indeterminate={bulkSelectionState.selectedIds.size > 0 && bulkSelectionState.selectedIds.size < sortedTables.length}
    onCheckedChange={handleSelectAll}
    className="mr-1 sm:mr-2"
  />
  <span className="text-sm text-muted-foreground">
    Select all ({sortedTables.length} tables)
  </span>
</div>
```

### Step 4: Enhance Bulk Export Functionality
```tsx
// Implement bulk export with progress tracking:
const handleBulkExport = useCallback(async () => {
  const selectedIds = Array.from(bulkSelectionState.selectedIds);
  
  if (selectedIds.length === 0) return;
  
  try {
    toast.loading('Preparing export...', { id: 'bulk-export' });
    
    // Option 1: Single ZIP export
    const response = await apiClient.tables.bulkExport(selectedIds);
    
    if (response.success) {
      // Download ZIP file
      const link = document.createElement('a');
      link.href = response.data.downloadUrl;
      link.download = `tables-export-${new Date().toISOString().split('T')[0]}.zip`;
      link.click();
      
      toast.success(`Exported ${selectedIds.length} tables`, { id: 'bulk-export' });
    }
  } catch (error) {
    toast.error('Failed to export tables', { id: 'bulk-export' });
  }
}, [bulkSelectionState.selectedIds]);
```

### Step 5: Implement Bulk Delete with Confirmation
```tsx
// Enhanced bulk delete with confirmation modal:
const handleBulkDelete = useCallback(async () => {
  const selectedIds = Array.from(bulkSelectionState.selectedIds);
  const tableNames = tables
    .filter(table => selectedIds.includes(table.id))
    .map(table => table.name);
  
  const confirmMessage = `Are you sure you want to delete ${selectedIds.length} table${selectedIds.length > 1 ? 's' : ''}?\n\n${tableNames.join('\n')}\n\nThis action cannot be undone.`;
  
  if (!confirm(confirmMessage)) return;
  
  try {
    toast.loading('Deleting tables...', { id: 'bulk-delete' });
    
    const response = await apiClient.tables.bulkDelete(selectedIds);
    
    if (response.success) {
      setTables(prev => prev.filter(table => !selectedIds.includes(table.id)));
      setBulkSelectionState({
        selectedIds: new Set(),
        isSelecting: false,
        showBulkActions: false
      });
      
      toast.success(`Deleted ${selectedIds.length} tables`, { id: 'bulk-delete' });
    }
  } catch (error) {
    toast.error('Failed to delete tables', { id: 'bulk-delete' });
  }
}, [bulkSelectionState.selectedIds, tables]);
```

### Step 6: Add Bulk Selection Toggle
```tsx
// Enhanced filter section with bulk selection toggle:
<div className="flex flex-col md:flex-row gap-3 sm:gap-4 mb-4 sm:mb-6">
  {/* Existing search and filters */}
  
  <Button
    variant="outline"
    onClick={() => setBulkSelectionState(prev => ({
      ...prev,
      showBulkActions: !prev.showBulkActions,
      selectedIds: new Set() // Clear selection when toggling
    }))}
    className={`w-full md:w-auto ${bulkSelectionState.showBulkActions ? "bg-blue-50 text-blue-700" : ""}`}
  >
    <CheckSquare className="mr-2 h-4 w-4" />
    {bulkSelectionState.showBulkActions ? 'Cancel Selection' : 'Select Tables'}
  </Button>
</div>
```

### Step 7: Add Keyboard Shortcuts for Bulk Actions
```tsx
// Add keyboard shortcuts for common bulk operations:
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // Only handle shortcuts when bulk selection is active
    if (!bulkSelectionState.showBulkActions || bulkSelectionState.selectedIds.size === 0) return;
    
    if (e.ctrlKey || e.metaKey) {
      switch (e.key) {
        case 'a':
          e.preventDefault();
          handleSelectAll();
          break;
        case 'e':
          e.preventDefault();
          handleBulkExport();
          break;
        case 'Backspace':
        case 'Delete':
          e.preventDefault();
          handleBulkDelete();
          break;
      }
    }
    
    if (e.key === 'Escape') {
      setBulkSelectionState(prev => ({
        ...prev,
        selectedIds: new Set(),
        showBulkActions: false
      }));
    }
  };

  document.addEventListener('keydown', handleKeyDown);
  return () => document.removeEventListener('keydown', handleKeyDown);
}, [bulkSelectionState, handleSelectAll, handleBulkExport, handleBulkDelete]);
```

## Acceptance Criteria

✅ **Bulk Selection**: Multi-table selection with visual feedback and count display
✅ **Select All**: Master checkbox with indeterminate state for partial selection
✅ **Bulk Actions**: Export and delete operations for selected tables
✅ **Visual Feedback**: Blue toolbar shows selected count and available actions
✅ **Responsive**: Bulk selection works on mobile and desktop layouts
✅ **Performance**: Efficient selection state management for large table lists

## QA Testing Checklist

### Selection Functionality
- [ ] Individual table selection via checkbox works
- [ ] Select all checkbox selects/deselects all visible tables
- [ ] Select all shows indeterminate state for partial selection
- [ ] Selection state persists during search/filter operations
- [ ] Selection visual feedback (blue highlighting) works

### Bulk Action Toolbar
- [ ] Toolbar appears when tables are selected (animated entrance)
- [ ] Shows correct count: "X table(s) selected"
- [ ] "Clear selection" button deselects all tables
- [ ] Export button triggers bulk export functionality
- [ ] Delete button shows confirmation before deletion
- [ ] Toolbar hides when no tables selected (animated exit)

### Bulk Export
- [ ] Export button enabled when tables selected
- [ ] Export includes all selected tables
- [ ] Export progress indication during processing
- [ ] Success message shows number of exported tables
- [ ] Error handling for failed exports

### Bulk Delete
- [ ] Delete confirmation shows table names
- [ ] Confirmation cancellation preserves selection
- [ ] Successful deletion removes tables from list
- [ ] Selection cleared after successful deletion
- [ ] Error handling for failed deletions

### Mobile Responsiveness
- [ ] Bulk selection toolbar responsive on mobile devices
- [ ] Checkboxes appropriately sized for touch interaction
- [ ] Action buttons stack properly on mobile
- [ ] Text remains readable at small screen sizes

### Performance
- [ ] Selection state updates without lag for 100+ tables
- [ ] Checkbox interactions are immediate and responsive
- [ ] Bulk operations don't freeze UI
- [ ] Memory usage reasonable with large selections

### Keyboard Shortcuts
- [ ] Ctrl/Cmd+A selects all tables (when bulk mode active)
- [ ] Ctrl/Cmd+E triggers bulk export
- [ ] Ctrl/Cmd+Delete triggers bulk delete
- [ ] Escape key clears selection and exits bulk mode
- [ ] Shortcuts only work when appropriate

### Integration Testing
- [ ] Bulk selection works with search filtering
- [ ] Selection preserved when switching between views
- [ ] Bulk actions respect table permissions
- [ ] No conflicts with individual table actions

## Backend API Requirements

### Bulk Export Endpoint
```
POST /api/tables/bulk-export
Body: { tableIds: string[] }
Response: { success: boolean, data: { downloadUrl: string } }
```

### Bulk Delete Endpoint
```
DELETE /api/tables/bulk-delete
Body: { tableIds: string[] }
Response: { success: boolean, data: { deletedCount: number } }
```

## Definition of Done
- [ ] BulkActionToolbar component extracted and functional
- [ ] Bulk selection state management optimized
- [ ] Select all functionality with indeterminate states
- [ ] Bulk export and delete operations working
- [ ] Keyboard shortcuts implemented
- [ ] Mobile responsiveness maintained
- [ ] Performance optimized for large table lists
- [ ] Ready for commit 3.3 (search and filtering) 