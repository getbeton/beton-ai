# Commit 2.3: Implement Upload Progress Tracking

## Goal
Replace simulated progress with real WebSocket progress tracking using the existing `UploadProgressOverlay` component

## Dependencies
- Commit 2.2: Connect file upload to backend API

## Files Modified
- `frontend/src/components/upload/UploadProgressOverlay.tsx` (extract from snippet)
- `frontend/src/hooks/useWebSocket.ts` (extend existing)
- `frontend/src/components/tables/TableDashboard.tsx` (integrate real WebSocket tracking)

## Implementation Steps

### Step 1: Extract UploadProgressOverlay Component
```tsx
// Extract from code snippet - already fully implemented:
const UploadProgressOverlay: React.FC<{ progress: UploadProgress }> = ({ progress }) => {
  const stages = [
    { key: "upload", label: "Uploading file", icon: Upload },
    { key: "parse", label: "Parsing CSV", icon: FileText },
    { key: "create", label: "Creating table", icon: Database },
    { key: "import", label: "Importing data", icon: CheckCircle },
  ];

  // Visual progress tracking with stage indicators
  // framer-motion animations for smooth transitions
  // Progress bar with percentage display
};
```

### Step 2: Study Existing WebSocket Implementation
```tsx
// Examine existing WebSocket patterns:
// - frontend/src/hooks/useWebSocket.ts
// - frontend/src/components/BulkDownloadModal.tsx progress tracking
// - Existing job ID → WebSocket connection mapping
// - Message handling for progress updates
```

### Step 3: Extend WebSocket Hook for CSV Jobs
```tsx
// Add CSV upload job tracking to existing useWebSocket:
interface CSVUploadProgress {
  jobId: string;
  type: 'csv_upload_progress';
  status: 'uploading' | 'parsing' | 'creating_table' | 'importing_data' | 'completed' | 'failed';
  progress: {
    stage: string;
    percentage: number;
    currentStep: string;
    totalSteps?: number;
    processedRows?: number;
    totalRows?: number;
  };
  tableId?: string;
  error?: string;
}

// Use existing WebSocket patterns for consistency
```

### Step 4: Update handleFileUpload with Real Progress Tracking
```tsx
// Replace simulated progress in TableDashboard:
const handleFileUpload = useCallback(async (files: File[]) => {
  // ... existing validation code ...

  setUploadProgress(progress);

  try {
    const response = await apiClient.tables.uploadCSV(file, tableName);
    
    if (response.success) {
      const jobId = response.data.jobId;
      
      setUploadProgress(prev => prev ? { 
        ...prev, 
        progress: 20, 
        stage: "parse",
        jobId 
      } : null);
      
      // Start WebSocket progress tracking
      startProgressTracking(jobId);
    }
  } catch (error) {
    // ... existing error handling ...
  }
}, []);

// WebSocket progress handler
const handleProgressUpdate = useCallback((progressData: CSVUploadProgress) => {
  if (!uploadProgress || progressData.jobId !== uploadProgress.jobId) return;

  setUploadProgress(prev => prev ? {
    ...prev,
    progress: progressData.progress.percentage,
    stage: mapBackendStageToFrontend(progressData.status),
    currentStep: progressData.progress.currentStep
  } : null);

  if (progressData.status === 'completed') {
    // Update table in list with final row/column counts
    updateTableFromProgress(progressData);
    
    setTimeout(() => setUploadProgress(null), 1500);
    toast.success('Table created successfully!');
  }
  
  if (progressData.status === 'failed') {
    setUploadProgress(prev => prev ? { 
      ...prev, 
      status: 'error',
      error: progressData.error 
    } : null);
    
    toast.error(progressData.error || 'Upload failed');
    setTimeout(() => setUploadProgress(null), 3000);
  }
}, [uploadProgress]);
```

### Step 5: Add Stage Mapping Functions
```tsx
// Map backend progress stages to frontend stages:
const mapBackendStageToFrontend = (backendStage: string): UploadProgress['stage'] => {
  const stageMap = {
    'uploading': 'upload',
    'parsing': 'parse', 
    'creating_table': 'create',
    'importing_data': 'import'
  };
  return stageMap[backendStage] || 'upload';
};

// Update progress percentages based on stage:
const getProgressPercentage = (stage: string, stageProgress?: number): number => {
  const baseProgress = {
    uploading: 0,
    parsing: 25,
    creating_table: 60,
    importing_data: 80
  };
  
  const baseValue = baseProgress[stage] || 0;
  const stageRange = 25; // Each stage covers ~25% of progress
  const stagePercent = (stageProgress || 0) / 100;
  
  return Math.min(100, baseValue + (stageRange * stagePercent));
};
```

### Step 6: Enhance UploadProgressOverlay with Error States
```tsx
// Add error handling to existing component:
{progress.status === 'error' && (
  <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
    <div className="flex items-center">
      <AlertCircle className="h-5 w-5 text-red-500 mr-2" />
      <span className="text-sm font-medium text-red-800">Upload Failed</span>
    </div>
    {progress.error && (
      <p className="text-sm text-red-600 mt-1">{progress.error}</p>
    )}
    <Button 
      variant="outline" 
      size="sm" 
      className="mt-2"
      onClick={() => setUploadProgress(null)}
    >
      Close
    </Button>
  </div>
)}
```

### Step 7: Add Completion Actions
```tsx
// Add actions when upload completes successfully:
{progress.status === 'success' && (
  <div className="mt-4 flex justify-between items-center">
    <div className="flex items-center text-green-600">
      <CheckCircle className="h-5 w-5 mr-2" />
      <span className="text-sm font-medium">Upload completed!</span>
    </div>
    <div className="space-x-2">
      <Button 
        variant="outline" 
        size="sm"
        onClick={() => setUploadProgress(null)}
      >
        Close
      </Button>
      <Button 
        size="sm"
        onClick={() => {
          setUploadProgress(null);
          // Navigate to table view
          router.push(`/dashboard/tables/${tableId}`);
        }}
      >
        View Table
      </Button>
    </div>
  </div>
)}
```

## Acceptance Criteria

✅ **Real Progress**: WebSocket-based real-time progress updates from backend
✅ **Visual Progress**: UploadProgressOverlay shows stages with icons and percentages
✅ **Stage Tracking**: Four stages tracked: upload → parse → create → import
✅ **Error Handling**: Failed uploads show error state with retry options
✅ **Completion**: Success state with option to view newly created table
✅ **Consistent UI**: Progress UI matches existing BulkDownloadModal patterns

## QA Testing Checklist

### Progress Tracking Integration
- [ ] WebSocket connection established when upload starts
- [ ] Real-time progress updates received and displayed
- [ ] Progress percentages accurate for each stage
- [ ] Stage transitions smooth and logical
- [ ] WebSocket messages processed without UI lag

### Visual Progress Display
- [ ] Upload stage (0-25%): Shows "Uploading file" with Upload icon
- [ ] Parse stage (25-60%): Shows "Parsing CSV" with FileText icon
- [ ] Create stage (60-80%): Shows "Creating table" with Database icon
- [ ] Import stage (80-100%): Shows "Importing data" with CheckCircle icon
- [ ] Progress bar updates smoothly with framer-motion animations

### Completion States
- [ ] Success: Shows green checkmark and completion message
- [ ] Success: "View Table" button navigates to new table
- [ ] Success: "Close" button dismisses progress overlay
- [ ] Success: New table appears at top of dashboard list
- [ ] Success: Toast notification shows success message

### Error Handling
- [ ] Failed uploads show red error state with AlertCircle icon
- [ ] Error message displays specific failure reason
- [ ] "Close" button available to dismiss error state
- [ ] Failed upload doesn't leave processing table in list
- [ ] Error toast notification shows appropriate message

### WebSocket Integration
- [ ] Progress updates only for correct jobId
- [ ] WebSocket disconnections handled gracefully
- [ ] Multiple concurrent uploads tracked separately
- [ ] Connection cleanup when upload completes/fails
- [ ] Fallback behavior if WebSocket unavailable

### UI/UX Polish
- [ ] Progress overlay centers properly on all screen sizes
- [ ] Animations smooth and not distracting
- [ ] Loading states don't block other UI interactions
- [ ] Modal backdrop prevents interaction with dashboard
- [ ] Progress text updates match actual processing stages

### Data Integration
- [ ] Completed tables show correct row and column counts
- [ ] Table status updates from "processing" to "ready"
- [ ] Last modified time accurate
- [ ] Table description populated appropriately

## Backend WebSocket Message Requirements

### Expected Message Format
```json
{
  "jobId": "csv_upload_job_12345",
  "type": "csv_upload_progress", 
  "status": "parsing",
  "progress": {
    "stage": "Parsing CSV data",
    "percentage": 45,
    "currentStep": "Validating row 2,150 of 5,000",
    "totalSteps": 5000,
    "processedRows": 2150,
    "totalRows": 5000
  },
  "tableId": "table_67890",
  "error": null
}
```

### Required Status Values
- `uploading`: File transfer in progress
- `parsing`: CSV data parsing and validation
- `creating_table`: Database table structure creation
- `importing_data`: Row data import to database
- `completed`: Process finished successfully
- `failed`: Process failed with error

## Definition of Done
- [ ] UploadProgressOverlay component extracted and enhanced
- [ ] WebSocket progress tracking integrated
- [ ] Real-time progress updates working
- [ ] Error states handled appropriately
- [ ] Success completion with navigation options
- [ ] UI matches existing progress component patterns
- [ ] All acceptance criteria met
- [ ] Ready for Phase 3 (Enhanced Table Management) 