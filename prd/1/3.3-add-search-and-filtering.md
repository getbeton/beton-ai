# Commit 3.3: Add Search and Filtering

## Goal
Enhance the existing search and filtering implementation from the code snippet with complete functionality

## Dependencies
- Commit 1.1: Move tables to primary dashboard

## Files Modified
- `frontend/src/components/tables/TableDashboard.tsx` (enhance existing search/filter implementation)
- `frontend/src/components/tables/TableSearch.tsx` (extract from snippet if needed)

## Implementation Steps

### Step 1: Enhance Existing Search Implementation
```tsx
// Current implementation already exists in code snippet:
const [searchQuery, setSearchQuery] = useState("");
const [selectedSource, setSelectedSource] = useState<string>("all");
const [selectedStatus, setSelectedStatus] = useState<string>("all");

// Search filtering logic already implemented:
const filteredTables = tables.filter((table) => {
  const matchesSearch = table.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    table.description?.toLowerCase().includes(searchQuery.toLowerCase());
  
  const matchesSource = selectedSource === "all" || table.source === selectedSource;
  const matchesStatus = selectedStatus === "all" || table.status === selectedStatus;

  return matchesSearch && matchesSource && matchesStatus;
});
```

### Step 2: Enhance Search Input with Debouncing
```tsx
// Add debounced search to prevent excessive filtering:
const [searchQuery, setSearchQuery] = useState("");
const [debouncedSearchQuery, setDebouncedSearchQuery] = useState("");

useEffect(() => {
  const timer = setTimeout(() => {
    setDebouncedSearchQuery(searchQuery);
  }, 300); // 300ms debounce

  return () => clearTimeout(timer);
}, [searchQuery]);

// Use debounced query in filtering logic:
const filteredTables = tables.filter((table) => {
  const matchesSearch = table.name.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) ||
    table.description?.toLowerCase().includes(debouncedSearchQuery.toLowerCase());
  // ... rest of filtering logic
});
```

### Step 3: Add Advanced Search Capabilities
```tsx
// Enhanced search to include more fields:
const getSearchableText = (table: TableData): string => {
  return [
    table.name,
    table.description || '',
    table.source,
    table.status,
    table.rows.toString(),
    table.columns.toString()
  ].join(' ').toLowerCase();
};

const filteredTables = tables.filter((table) => {
  const searchableText = getSearchableText(table);
  const searchTerms = debouncedSearchQuery.toLowerCase().split(' ').filter(term => term.length > 0);
  
  const matchesSearch = searchTerms.length === 0 || 
    searchTerms.every(term => searchableText.includes(term));
  
  const matchesSource = selectedSource === "all" || table.source === selectedSource;
  const matchesStatus = selectedStatus === "all" || table.status === selectedStatus;

  return matchesSearch && matchesSource && matchesStatus;
});
```

### Step 4: Enhance Filter UI with Clear Indicators
```tsx
// Add filter clear functionality and active filter indicators:
const hasActiveFilters = selectedSource !== "all" || selectedStatus !== "all" || searchQuery.length > 0;

const clearAllFilters = useCallback(() => {
  setSearchQuery("");
  setSelectedSource("all");
  setSelectedStatus("all");
}, []);

// Enhanced search input with clear button:
<div className="relative flex-1">
  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4" />
  <Input
    placeholder="Search tables by name, description..."
    value={searchQuery}
    onChange={(e) => setSearchQuery(e.target.value)}
    className="pl-10 pr-10 w-full"
  />
  {searchQuery && (
    <Button
      variant="ghost"
      size="sm"
      onClick={() => setSearchQuery("")}
      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0"
    >
      <X className="h-4 w-4" />
    </Button>
  )}
</div>
```

### Step 5: Add Filter Combination Logic with Results Count
```tsx
// Add results count and empty state handling:
const [showEmptyMessage, setShowEmptyMessage] = useState(false);

useEffect(() => {
  // Show empty message after brief delay to avoid flashing
  const timer = setTimeout(() => {
    setShowEmptyMessage(filteredTables.length === 0 && hasActiveFilters);
  }, 150);

  return () => clearTimeout(timer);
}, [filteredTables.length, hasActiveFilters]);

// Results count display:
<div className="flex items-center justify-between mb-4">
  <div className="flex items-center space-x-4">
    <h2 className="text-lg font-semibold">
      {filteredTables.length} {filteredTables.length === 1 ? 'table' : 'tables'}
      {hasActiveFilters && ` found`}
    </h2>
    {hasActiveFilters && (
      <Button variant="ghost" size="sm" onClick={clearAllFilters}>
        Clear filters
      </Button>
    )}
  </div>
</div>
```

### Step 6: Add Smart Filter Suggestions
```tsx
// Add filter suggestions based on available data:
const getFilterSuggestions = useCallback(() => {
  const sources = Array.from(new Set(tables.map(table => table.source)));
  const statuses = Array.from(new Set(tables.map(table => table.status)));
  
  return {
    sources: sources.map(source => ({
      value: source,
      label: source,
      count: tables.filter(table => table.source === source).length
    })),
    statuses: statuses.map(status => ({
      value: status,
      label: status.charAt(0).toUpperCase() + status.slice(1),
      count: tables.filter(table => table.status === status).length
    }))
  };
}, [tables]);

// Enhanced Select components with counts:
<Select value={selectedSource} onValueChange={setSelectedSource}>
  <SelectTrigger className="w-full md:w-[180px]">
    <SelectValue placeholder="Filter by Source" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="all">All Sources ({tables.length})</SelectItem>
    {getFilterSuggestions().sources.map(source => (
      <SelectItem key={source.value} value={source.value}>
        {source.label} ({source.count})
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

### Step 7: Add Filter Persistence and URL State
```tsx
// Add URL parameter persistence for filters:
const router = useRouter();
const searchParams = useSearchParams();

useEffect(() => {
  // Load filters from URL on mount
  const urlSearch = searchParams.get('search') || '';
  const urlSource = searchParams.get('source') || 'all';
  const urlStatus = searchParams.get('status') || 'all';
  
  setSearchQuery(urlSearch);
  setSelectedSource(urlSource);
  setSelectedStatus(urlStatus);
}, []);

useEffect(() => {
  // Update URL when filters change
  const params = new URLSearchParams();
  if (searchQuery) params.set('search', searchQuery);
  if (selectedSource !== 'all') params.set('source', selectedSource);
  if (selectedStatus !== 'all') params.set('status', selectedStatus);
  
  const newUrl = params.toString() ? `?${params.toString()}` : '';
  router.replace(`/dashboard${newUrl}`, { scroll: false });
}, [searchQuery, selectedSource, selectedStatus, router]);
```

## Acceptance Criteria

✅ **Real-time Search**: Search input filters tables immediately with debouncing
✅ **Multi-field Search**: Search works on table name and description
✅ **Source Filtering**: Filter by CSV, Apollo, Manual sources with counts
✅ **Status Filtering**: Filter by ready, processing, error status with counts
✅ **Combined Filters**: Search and filters work together correctly
✅ **Clear Functionality**: Easy way to clear individual and all filters

## QA Testing Checklist

### Search Functionality
- [ ] Search input filters tables by name in real-time
- [ ] Search filters tables by description text
- [ ] Search is case-insensitive
- [ ] Search supports multiple words (AND logic)
- [ ] Search input shows clear (X) button when text entered
- [ ] Clear button removes search text and resets results

### Source Filtering
- [ ] "All Sources" shows all tables with total count
- [ ] "CSV" filter shows only CSV-imported tables
- [ ] "Apollo" filter shows only Apollo-imported tables  
- [ ] "Manual" filter shows only manually created tables
- [ ] Each filter option shows count of matching tables
- [ ] Source filter combines correctly with search

### Status Filtering
- [ ] "All Statuses" shows all tables with total count
- [ ] "Ready" filter shows only ready tables
- [ ] "Processing" filter shows only processing tables
- [ ] "Error" filter shows only error tables
- [ ] Each status option shows count of matching tables
- [ ] Status filter combines correctly with search and source

### Combined Filtering
- [ ] Search + source filter work together
- [ ] Search + status filter work together
- [ ] Source + status filter work together
- [ ] All three filters work together correctly
- [ ] Results count updates correctly with filter combinations

### Filter State Management
- [ ] Filters persist during table operations
- [ ] Filters reset appropriately after table deletion
- [ ] Filter state preserved during page navigation
- [ ] URL reflects current filter state
- [ ] Browser back/forward respects filter state

### Empty States
- [ ] No search results shows appropriate empty message
- [ ] Empty message suggests clearing filters
- [ ] Empty state appears after brief delay (no flashing)
- [ ] Empty state disappears when filters change

### Performance
- [ ] Search debouncing prevents excessive filtering (300ms delay)
- [ ] Large table lists filter smoothly without lag
- [ ] Filter dropdown loading is instant
- [ ] No memory leaks with filter state changes

### Responsive Design
- [ ] Search input full width on mobile
- [ ] Filter dropdowns stack properly on mobile
- [ ] Filter controls accessible on touch devices
- [ ] Results count readable on small screens

### Accessibility
- [ ] Search input has proper placeholder text
- [ ] Filter dropdowns have descriptive labels
- [ ] Clear buttons have accessible labels
- [ ] Keyboard navigation works through filters

## Integration Testing

### With Bulk Selection
- [ ] Filtered selection works with bulk operations
- [ ] Select all only selects visible (filtered) tables
- [ ] Bulk actions work correctly on filtered results
- [ ] Selection state preserved during filter changes

### With Table Operations
- [ ] New table creation respects current filters
- [ ] Table updates reflect in filtered results
- [ ] Table deletion updates filter counts
- [ ] Processing status changes update filter results

## Definition of Done
- [ ] Search functionality enhanced with debouncing
- [ ] Advanced multi-field search implemented
- [ ] Source and status filtering with counts
- [ ] Combined filter logic working correctly
- [ ] Filter clearing and reset functionality
- [ ] URL state persistence implemented
- [ ] Empty states and loading states handled
- [ ] Ready for commit 4.1 (drop zone integration) 