# Commit 2.2: Connect File Upload to Existing Backend API

## Goal
Replace the simulated upload progress with real backend API integration using existing patterns

## Dependencies
- Commit 2.1: Integrate drag-and-drop library

## Files Modified
- `frontend/src/components/tables/TableDashboard.tsx` (update handleFileUpload function)
- `frontend/src/lib/api.ts` (add CSV upload endpoint)
- `frontend/src/lib/utils.ts` (add file validation utilities)

## Implementation Steps

### Step 1: Research Existing Backend Endpoints
1. Study `frontend/src/lib/api.ts` to understand current patterns
2. Examine existing authentication with Supabase integration
3. Review `backend/src/routes/tables.ts` for bulk processing patterns
4. Check existing error handling and response formats

### Step 2: Add CSV Upload API Method
```tsx
// Add to existing apiClient in lib/api.ts:
export const apiClient = {
  // ... existing methods
  tables: {
    // ... existing table methods
    uploadCSV: async (file: File, tableName?: string): Promise<ApiResponse<{ jobId: string; tableId: string }>> => {
      const formData = new FormData();
      formData.append('file', file);
      if (tableName) formData.append('tableName', tableName);
      
      const response = await fetch(`${API_BASE_URL}/api/tables/upload-csv`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${await getSupabaseToken()}`,
          // Don't set Content-Type - let browser set it for FormData
        },
        body: formData,
      });
      
      if (!response.ok) {
        throw new Error(`Upload failed: ${response.statusText}`);
      }
      
      return response.json();
    }
  }
};
```

### Step 3: Update handleFileUpload Function
```tsx
// Replace simulated upload with real backend call:
const handleFileUpload = useCallback(async (files: File[]) => {
  if (files.length === 0) return;

  const file = files[0];
  
  // File validation
  if (!file.name.endsWith(".csv")) {
    toast.error("Please upload a CSV file");
    return;
  }
  
  if (file.size > 50 * 1024 * 1024) { // 50MB limit
    toast.error("File too large. Maximum size is 50MB");
    return;
  }

  // Generate table name from filename
  const tableName = file.name.replace(".csv", "").replace(/[^a-zA-Z0-9\s]/g, "");

  const progress: UploadProgress = {
    fileName: file.name,
    progress: 0,
    stage: "upload",
    status: "uploading",
  };

  setUploadProgress(progress);

  try {
    // Start upload
    setUploadProgress(prev => prev ? { ...prev, progress: 10, stage: "upload" } : null);
    
    const response = await apiClient.tables.uploadCSV(file, tableName);
    
    if (response.success) {
      // Upload complete, backend processing begins
      setUploadProgress(prev => prev ? { 
        ...prev, 
        progress: 30, 
        stage: "parse",
        jobId: response.data.jobId 
      } : null);
      
      // Progress tracking will be handled by WebSocket in commit 2.3
      // For now, simulate completion
      setTimeout(() => {
        const newTable: TableData = {
          id: response.data.tableId,
          name: tableName,
          rows: 0, // Will be updated by WebSocket
          columns: 0, // Will be updated by WebSocket  
          source: "CSV",
          lastModified: new Date(),
          status: "processing",
          description: "Recently uploaded CSV file",
        };

        setTables((prev) => [newTable, ...prev]);
        setUploadProgress(prev => prev ? { ...prev, progress: 100, status: "success" } : null);
        
        setTimeout(() => setUploadProgress(null), 1500);
      }, 2000);
    }
  } catch (error: any) {
    console.error('Upload failed:', error);
    setUploadProgress(prev => prev ? { 
      ...prev, 
      status: "error",
      error: error.message 
    } : null);
    
    toast.error(error.message || 'Failed to upload CSV file');
    
    setTimeout(() => setUploadProgress(null), 3000);
  }
}, []);
```

### Step 4: Add File Validation Utilities
```tsx
// Add to lib/utils.ts:
export const validateCSVFile = (file: File): { valid: boolean; error?: string } => {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    return { valid: false, error: 'Please upload a CSV file' };
  }
  
  if (file.size > 50 * 1024 * 1024) {
    return { valid: false, error: 'File too large. Maximum size is 50MB' };
  }
  
  if (file.size === 0) {
    return { valid: false, error: 'File is empty' };
  }
  
  return { valid: true };
};

export const generateTableNameFromFile = (filename: string): string => {
  return filename
    .replace('.csv', '')
    .replace(/[^a-zA-Z0-9\s]/g, '')
    .trim()
    .substring(0, 50); // Limit length
};
```

### Step 5: Integrate with Existing Authentication
```tsx
// Use existing Supabase auth pattern:
const getSupabaseToken = async (): Promise<string> => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session?.access_token) {
    throw new Error('Not authenticated');
  }
  return session.access_token;
};
```

### Step 6: Add Error Handling
```tsx
// Update UploadProgress interface to include error state:
interface UploadProgress {
  fileName: string;
  progress: number;
  stage: "upload" | "parse" | "create" | "import";
  status: "uploading" | "success" | "error";
  jobId?: string;
  error?: string;
}

// Add error display in UploadProgressOverlay component
```

### Step 7: Integrate with Existing Toast System
```tsx
// Use existing toast patterns:
import toast from 'react-hot-toast';

// Success: toast.success('Table created successfully!')
// Error: toast.error('Failed to upload CSV file')
// Loading: toast.loading('Uploading CSV...') with manual dismiss
```

## Acceptance Criteria

✅ **Backend Connection**: CSV files upload to backend using existing API patterns
✅ **Authentication**: Upload uses existing Supabase authentication
✅ **File Validation**: Client-side validation before upload (type, size, empty)
✅ **Progress Indication**: Basic upload progress shown during file transfer
✅ **Error Handling**: Network and validation errors handled with toast notifications
✅ **Table Creation**: Successful upload creates table entry in dashboard

## QA Testing Checklist

### Upload Functionality
- [ ] Drop valid CSV file → file uploads to backend successfully
- [ ] Upload includes proper Supabase authentication headers
- [ ] Backend receives file and returns jobId + tableId
- [ ] Upload progress shows during file transfer (0-30%)
- [ ] New table appears in dashboard list after upload

### File Validation
- [ ] CSV files (.csv extension) accepted
- [ ] Non-CSV files rejected with error toast
- [ ] Files over 50MB rejected with size error
- [ ] Empty files (0 bytes) rejected with error
- [ ] Table name generated correctly from filename

### Authentication Integration
- [ ] Authenticated users can upload files
- [ ] Unauthenticated users get auth error
- [ ] Expired tokens handled gracefully
- [ ] Auth errors show appropriate messages

### Error Handling
- [ ] Network failures show error toast and progress error state
- [ ] Invalid file types rejected before upload attempt
- [ ] Server errors (4xx/5xx) display user-friendly messages
- [ ] Upload failures allow retry (progress overlay dismisses)

### Progress Indication
- [ ] Upload progress shows: 0% → 10% (start) → 30% (complete)
- [ ] Processing state shows after upload completion
- [ ] Loading states prevent multiple concurrent uploads
- [ ] Progress overlay dismissible on error

### Backend Integration
- [ ] FormData sent with proper Content-Type header
- [ ] File and tableName fields included in request
- [ ] Response includes jobId for progress tracking
- [ ] Response includes tableId for table reference

### API Consistency
- [ ] Upload API follows existing `apiClient` patterns
- [ ] Error responses match existing API error format
- [ ] Success responses include required tracking data
- [ ] Authentication headers match existing calls

## Backend Endpoint Requirements

**Expected endpoint**: `POST /api/tables/upload-csv`

**Request format**:
```
Content-Type: multipart/form-data
Authorization: Bearer {supabase_token}
Body: FormData with 'file' and optional 'tableName' fields
```

**Response format**:
```json
{
  "success": true,
  "data": {
    "jobId": "job_12345",
    "tableId": "table_67890",
    "tableName": "Generated or provided name"
  }
}
```

**Error response**:
```json
{
  "success": false,
  "error": "User-friendly error message"
}
```

## Definition of Done
- [ ] CSV upload API method added to apiClient
- [ ] handleFileUpload updated with real backend integration
- [ ] File validation utilities implemented
- [ ] Authentication integration working
- [ ] Error handling follows existing patterns
- [ ] Toast notifications integrated
- [ ] Progress tracking prepared for WebSocket integration
- [ ] Ready for commit 2.3 (WebSocket progress tracking) 