generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Integration {
  id              String          @id @default(cuid())
  userId          String
  serviceName     String
  name            String
  isActive        Boolean         @default(true)
  lastHealthCheck DateTime?
  healthStatus    String          @default("unknown")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  keySource       String          @default("personal")
  platformKeyId   String?
  apiKeys         ApiKey[]
  platformKey     PlatformApiKey? @relation(fields: [platformKeyId], references: [id])

  @@unique([userId, serviceName, name])
  @@map("integrations")
}

model ApiKey {
  id            String      @id @default(cuid())
  integrationId String
  apiKey        String
  keyType       String
  isActive      Boolean     @default(true)
  lastUsed      DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, keyType])
  @@map("api_keys")
}

model PlatformApiKey {
  id           String        @id @default(cuid())
  serviceName  String        @unique
  apiKey       String
  isActive     Boolean       @default(true)
  description  String?
  rateLimit    Int?
  usageCount   Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  integrations Integration[]

  @@map("platform_api_keys")
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  theme     String   @default("light")
  language  String   @default("en")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model UserTable {
  id               String             @id @default(cuid())
  userId           String
  name             String
  description      String?
  sourceType       String             @default("manual")
  sourceId         String?
  isArchived       Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  isProcessing     Boolean            @default(false)
  processingJobId  String?
  bulkJobs         BulkDownloadJob[]
  columns          TableColumn[]
  rows             TableRow[]
  aiTaskJobs       AiTaskJob[]
  incomingWebhooks IncomingWebhook[]
  outboundWebhooks OutboundWebhook[]

  @@unique([userId, name])
  @@map("user_tables")
}

model TableColumn {
  id           String      @id @default(cuid())
  tableId      String
  name         String
  type         String
  isRequired   Boolean     @default(false)
  isEditable   Boolean     @default(true)
  defaultValue String?
  order        Int
  settings     Json        @default("{}")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  cells        TableCell[]
  table        UserTable   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  aiTaskJobs   AiTaskJob[]

  @@unique([tableId, name])
  @@map("table_columns")
}

model TableRow {
  id          String      @id @default(cuid())
  tableId     String
  sourceRowId String?
  isSelected  Boolean     @default(false)
  order       Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  cells       TableCell[]
  table       UserTable   @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@map("table_rows")
}

model TableCell {
  id               String            @id @default(cuid())
  rowId            String
  columnId         String
  value            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  column           TableColumn       @relation(fields: [columnId], references: [id], onDelete: Cascade)
  row              TableRow          @relation(fields: [rowId], references: [id], onDelete: Cascade)
  aiTaskExecutions AiTaskExecution[]

  @@unique([rowId, columnId])
  @@map("table_cells")
}

model BulkDownloadJob {
  id              String                 @id @default(cuid())
  userId          String
  tableId         String
  jobType         String                 @default("apollo_people_search")
  status          String                 @default("pending")
  searchQuery     Json
  totalEstimated  Int?
  totalProcessed  Int                    @default(0)
  currentPage     Int                    @default(1)
  totalPages      Int?
  failureCount    Int                    @default(0)
  lastError       String?
  maxRetries      Int                    @default(3)
  bullJobId       String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  table           UserTable              @relation(fields: [tableId], references: [id])
  progressEntries BulkDownloadProgress[]

  @@map("bulk_download_jobs")
}

model BulkDownloadProgress {
  id          String          @id @default(cuid())
  jobId       String
  page        Int
  recordCount Int
  status      String
  error       String?
  processedAt DateTime        @default(now())
  job         BulkDownloadJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, page])
  @@map("bulk_download_progress")
}

model AiTaskJob {
  id              String            @id @default(cuid())
  userId          String
  tableId         String
  columnId        String
  integrationId   String
  prompt          String
  modelConfig     Json              @default("{}")
  executionScope  String            // 'column' | 'selected_rows' | 'single_row' | 'single_cell'
  targetRowIds    String[]          @default([])
  targetCellId    String?
  status          String            @default("pending") // 'pending' | 'running' | 'completed' | 'failed' | 'cancelled'
  totalTasks      Int               @default(0)
  completedTasks  Int               @default(0)
  failedTasks     Int               @default(0)
  bullJobId       String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  table           UserTable         @relation(fields: [tableId], references: [id], onDelete: Cascade)
  column          TableColumn       @relation(fields: [columnId], references: [id], onDelete: Cascade)
  executions      AiTaskExecution[]

  @@map("ai_task_jobs")
}

model AiTaskExecution {
  id          String      @id @default(cuid())
  jobId       String
  cellId      String
  prompt      String      // processed prompt with variables substituted
  status      String      @default("pending") // 'pending' | 'running' | 'completed' | 'failed'
  result      String?
  error       String?
  tokensUsed  Int?
  cost        Decimal?    @db.Decimal(10, 6)
  executedAt  DateTime?
  createdAt   DateTime    @default(now())
  job         AiTaskJob   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  cell        TableCell   @relation(fields: [cellId], references: [id], onDelete: Cascade)

  @@map("ai_task_executions")
}

model IncomingWebhook {
  id             String    @id @default(cuid())
  userId         String
  tableId        String    @unique
  url            String    @unique
  apiKey         String    @unique // API key for authenticating webhook requests
  isActive       Boolean   @default(true)
  fieldMapping   Json      @default("{}")
  receivedCount  Int       @default(0)
  lastReceivedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  table          UserTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([apiKey])
  @@map("incoming_webhooks")
}

model OutboundWebhook {
  id             String             @id @default(cuid())
  userId         String
  tableId        String
  url            String
  events         String[]           @default([])
  isActive       Boolean            @default(true)
  secretKey      String?
  retryCount     Int                @default(3)
  timeout        Int                @default(30000)
  deliveryCount  Int                @default(0)
  successCount   Int                @default(0)
  failureCount   Int                @default(0)
  lastDeliveryAt DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  table          UserTable          @relation(fields: [tableId], references: [id], onDelete: Cascade)
  deliveries     WebhookDelivery[]

  @@index([userId])
  @@index([tableId])
  @@map("outbound_webhooks")
}

model WebhookDelivery {
  id           String          @id @default(cuid())
  webhookId    String
  event        String
  payload      Json
  statusCode   Int?
  responseBody String?
  responseTime Int?
  success      Boolean         @default(false)
  attempt      Int             @default(1)
  error        String?
  createdAt    DateTime        @default(now())
  webhook      OutboundWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_deliveries")
}
